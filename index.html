<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>회원 관리 정보</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>

<body>
  <div id="loadingOverlay">
    <div class="loader"></div>
    <div>데이터를 처리중입니다...</div>
  </div>

  <div class="container">
    <script>
      let selectedMemberId = "";
      let currentMemberId = "일반회원";
    </script>

    <div class="header" id="headerSection">
      <div class="title" id="pageTitle">우리집 데이케어 센터 회원 관리</div>
    </div>

    <div class="button-group" id="mainButtonGroup">
      <div class="search-area">
        <div class="reference-date-container">
          <input type="date" class="reference-date-input" name="referenceDate" id="referenceDate" />
        </div>
        <button class="btn search-button" id="activeMemberBtn">
          등록회원 조회
        </button>
        <button class="btn search-button" id="allMemberBtn">
          전체회원 조회
        </button>
      </div>
      <div class="button-container">
        <button class="btn" id="counselingMemberBtn">상담회원등록</button>
        <button class="btn" id="newMemberBtn">신규회원등록</button>
      </div>
    </div>

    <div class="content-wrapper" id="contentArea">
      <div class="member-list" id="memberListContainer">
        <h3 class="member-list-title" id="memberListTitle">회원 목록</h3>
        <div class="table-container">
          <table id="memberTable">
            <thead>
              <tr>
                <th>회원번호</th>
                <th>회원명</th>
                <th>휴대전화번호</th>
                <th>생년월일</th>
                <th>입소일</th>
                <th>퇴소일</th>
              </tr>
            </thead>
            <tbody id="memberTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="member-form-container" id="memberFormWrapper">
        <form id="memberForm">
          <div class="info-frame_main" id="basicInfoFrame">
            <h3 class="info-section-title" id="basicInfoTitle">기본 정보</h3>
            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">회원번호</label>
                <input type="text" class="form-input" name="memberId" id="memberId" readonly
                  style="background-color: #e9f2ef" />
                <input type="hidden" id="generatedId" name="generatedId" />
              </div>
              <div class="col-3">
                <label class="form-label">회원명</label>
                <input type="text" class="form-input" name="name" id="name" />
              </div>
              <div class="col-3">
                <label class="form-label">장기요양번호</label>
                <input type="text" class="form-input" name="careNumber" id="careNumber"
                  placeholder="예) 12345678-23-123456" />
              </div>
            </div>

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">주민등록번호</label>
                <input type="text" class="form-input ssn-input" name="ssn" id="ssn" placeholder="상담회원의 경우 임의번호 기재" />
              </div>
              <div class="col-3">
                <label class="form-label">생년월일</label>
                <input type="text" class="form-input" name="birthdate" id="birthdate" placeholder="ex)20250101" />
              </div>
              <div class="col-3">
                <label class="form-label">(만)나이</label>
                <input type="text" class="form-input" name="age" id="age" readonly style="background-color: #e9f2ef" />
              </div>
            </div>

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">입소일</label>
                <input type="text" class="form-input" name="admissionDate" id="admissionDate"
                  placeholder="ex)20250101" />
              </div>
              <div class="col-3">
                <label class="form-label">퇴소일</label>
                <input type="text" class="form-input" name="dischargeDate" id="dischargeDate" value="99991231"
                  placeholder="ex)99991231" />
              </div>
              <div class="col-3">
              </div>
            </div>

            <div class="row-1col">
              <div class="col-1">
                <label class="form-label">주소</label>
                <input type="text" class="form-input" name="address" id="address" />
              </div>
            </div>

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">휴대전화번호</label>
                <input type="text" class="form-input" name="mobile" id="mobile" maxlength="13" />
              </div>
              <div class="col-3">
                <label class="form-label">비상연락망</label>
                <input type="text" class="form-input" name="emergencyContact" id="emergencyContact" maxlength="13" />
              </div>
              <div class="col-3">
                <label class="form-label">이메일주소</label>
                <input type="email" class="form-input" name="email" id="email" />
              </div>
            </div>

            <hr style="
                  width: 100%;
                  height: 1px;
                  background-color: #ddd;
                  margin: 0.2rem 0;
                " />

            <div class="row-2col">
              <div class="col-2">
                <label class="form-label">복용약물정보</label>
                <input type="text" class="form-input" name="medications" id="medications" />
              </div>
              <div class="col-2">
                <label class="form-label">알레르기정보</label>
                <input type="text" class="form-input" name="allergies" id="allergies" />
              </div>
            </div>

            <div class="row-2col">
              <div class="col-2">
                <label class="form-label">진료병원</label>
                <input type="text" class="form-input" name="hospital" id="hospital" />
              </div>
              <div class="col-2">
                <label class="form-label">주요진료이력</label>
                <input type="text" class="form-input" name="medicalHistory" id="medicalHistory" />
              </div>
            </div>

            <hr style="
                  width: 100%;
                  height: 1px;
                  background-color: #ddd;
                  margin: 0.2rem 0;
                " />

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">보호자관계</label>
                <select class="form-input" name="guardianRelation" id="guardianRelation">
                  <option value="선택">선택</option>
                  <option value="배우자">배우자</option>
                  <option value="아들">자녀</option>
                  <option value="딸">며느리/사위</option>
                  <option value="형제/자매">형제/자매</option>
                  <option value="손자/손녀">손자/손녀</option>
                  <option value="며느리">부모</option>
                  <option value="사위">친척</option>
                  <option value="기타">기타</option>
                </select>
              </div>
              <div class="col-3">
                <label class="form-label">보호자명</label>
                <input type="text" class="form-input" name="guardianName" id="guardianName" />
              </div>
              <div class="col-3">
                <label class="form-label">보호자연락처</label>
                <input type="text" class="form-input" name="guardianContact" id="guardianContact" maxlength="13" />
              </div>
            </div>

            <div class="row-3col">
              <div class="col-3">
                <label class="form-label">동거인관계</label>
                <select class="form-input" name="livingWith" id="livingWith">
                  <option value="선택">선택</option>
                  <option value="배우자">배우자</option>
                  <option value="아들">자녀</option>
                  <option value="딸">며느리/사위</option>
                  <option value="형제/자매">형제/자매</option>
                  <option value="손자/손녀">손자/손녀</option>
                  <option value="며느리">부모</option>
                  <option value="사위">친척</option>
                  <option value="기타">기타</option>
                </select>
              </div>
              <div class="col-3">
                <label class="form-label">동거인명</label>
                <input type="text" class="form-input" name="livingWithName" id="livingWithName" />
              </div>
              <div class="col-3">
                <label class="form-label">동거인연락처</label>
                <input type="text" class="form-input" name="livingWithContact" id="livingWithContact" maxlength="13" />
              </div>
            </div>

            <hr style="
                  width: 100%;
                  height: 1px;
                  background-color: #ddd;
                  margin: 0.2rem 0;
                " />

            <div class="row-1col">
              <div class="col-1">
                <label class="form-label">회원 주요 기대 및 요구</label>
                <input type="text" class="form-input" name="memberNeeds" id="memberNeeds" />
              </div>
            </div>

            <div class="row-1col">
              <div class="col-1">
                <label class="form-label">보호자 주요 기대 및 요구</label>
                <input type="text" class="form-input" name="guardianNeeds" id="guardianNeeds" />
              </div>
            </div>

            <div class="row-1col">
              <div class="col-1">
                <label class="form-label">주요 하루일과</label>
                <input type="text" class="form-input" name="dailyRoutine" id="dailyRoutine" />
              </div>
            </div>
          </div>

          <div class="button-group form-button-group" id="formButtonGroup" style="margin-top: 0.3rem">
            <button type="button" class="btn form-button" id="convertBtn">
              회원전환
            </button>
            <button type="button" class="btn form-button" id="resetBtn">
              초기화
            </button>
            <button type="button" class="btn form-button" id="submitBtn">
              입력
            </button>
            <button type="button" class="btn form-button" id="editBtn">
              수정
            </button>
            <button type="button" class="btn form-button" id="deleteBtn">
              삭제
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="customModal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-title">알림</div>
        <div class="modal-close">&times;</div>
      </div>
      <div class="modal-body" id="modalMessage">
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="modalConfirmBtn">확인</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirmModal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-title">확인</div>
        <div class="modal-close">&times;</div>
      </div>
      <div class="modal-body" id="confirmModalMessage">
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="confirmYesBtn">확인</button>
        <button class="modal-btn cancel-btn" id="confirmNoBtn">취소</button>
      </div>
    </div>
  </div>

  <script>
    function showModal(message) {
      const modalMessage = document.getElementById("modalMessage");
      const customModal = document.getElementById("customModal");
      if (modalMessage) modalMessage.textContent = message;
      if (customModal) customModal.style.display = "flex";
    }

    function closeModal() {
      const customModal = document.getElementById("customModal");
      const confirmModal = document.getElementById("confirmModal");
      if (customModal) customModal.style.display = "none";
      if (confirmModal) confirmModal.style.display = "none";
    }

    function showConfirmModal(message) {
      return new Promise((resolve) => {
        const confirmModal = document.getElementById("confirmModal");
        const confirmMessage = document.getElementById("confirmModalMessage");
        const yesBtn = document.getElementById("confirmYesBtn");
        const noBtn = document.getElementById("confirmNoBtn");
        const closeBtn = confirmModal.querySelector(".modal-close");

        if (confirmMessage) {
          confirmMessage.textContent = message;
        }

        if (confirmModal) {
          confirmModal.style.display = "flex";
        }

        function handleYes() {
          if (confirmModal) {
            confirmModal.style.display = "none";
          }
          cleanup();
          resolve(true);
        }

        function handleNo() {
          if (confirmModal) {
            confirmModal.style.display = "none";
          }
          cleanup();
          resolve(false);
        }

        function cleanup() {
          if (yesBtn) {
            yesBtn.removeEventListener("click", handleYes);
          }
          if (noBtn) {
            noBtn.removeEventListener("click", handleNo);
          }
          if (closeBtn) {
            closeBtn.removeEventListener("click", handleNo);
          }
        }

        if (yesBtn) {
          yesBtn.addEventListener("click", handleYes);
        }
        if (noBtn) {
          noBtn.addEventListener("click", handleNo);
        }
        if (closeBtn) {
          closeBtn.addEventListener("click", handleNo);
        }
      });
    }

    function showAlert(message) {
      showModal(message);
    }

    function showLoading() {
      document.getElementById("loadingOverlay").style.display = "flex";
    }

    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    function allClearContents() {
      document.getElementById("memberId").value = "";
      document.getElementById("name").value = "";
      document.getElementById("careNumber").value = "";
      document.getElementById("ssn").value = "";
      document.getElementById("birthdate").value = "";
      document.getElementById("age").value = "";
      document.getElementById("admissionDate").value = "";
      document.getElementById("dischargeDate").value = "";
      document.getElementById("address").value = "";
      document.getElementById("mobile").value = "";
      document.getElementById("emergencyContact").value = "";
      document.getElementById("email").value = "";
      document.getElementById("medications").value = "";
      document.getElementById("allergies").value = "";
      document.getElementById("hospital").value = "";
      document.getElementById("medicalHistory").value = "";
      document.getElementById("guardianRelation").value = "선택";
      document.getElementById("guardianName").value = "";
      document.getElementById("guardianContact").value = "";
      document.getElementById("livingWith").value = "선택";
      document.getElementById("livingWithName").value = "";
      document.getElementById("livingWithContact").value = "";
      document.getElementById("memberNeeds").value = "";
      document.getElementById("guardianNeeds").value = "";
      document.getElementById("dailyRoutine").value = "";

      document.getElementById("generatedId").value = "";

      selectedMemberId = "";

      document.getElementById("submitBtn").disabled = false;
      document.getElementById("editBtn").disabled = true;
      document.getElementById("deleteBtn").disabled = true;
    }

    function date8numberCheck(value) {
      if (value === "") {
        return true;
      }

      const regex = /^\d{8}$/;
      return regex.test(value);
    }

    function manAge(birthDateStr) {
      if (!birthDateStr || !date8numberCheck(birthDateStr)) {
        return "";
      }

      const year = parseInt(birthDateStr.substring(0, 4));
      const month = parseInt(birthDateStr.substring(4, 6));
      const day = parseInt(birthDateStr.substring(6, 8));

      const birthDate = new Date(year, month - 1, day);
      if (
        birthDate.getFullYear() !== year ||
        birthDate.getMonth() !== month - 1 ||
        birthDate.getDate() !== day
      ) {
        return "";
      }

      const today = new Date();

      let age = today.getFullYear() - birthDate.getFullYear();

      const isBirthdayPassed =
        today.getMonth() > birthDate.getMonth() ||
        (today.getMonth() === birthDate.getMonth() &&
          today.getDate() >= birthDate.getDate());

      if (!isBirthdayPassed) {
        age--;
      }

      return age.toString();
    }

    function idNumberCheck(value) {
      if (value === "") {
        return true;
      }

      const cleanValue = value.replace(/-/g, "");

      const regex = /^\d{13}$/;
      return regex.test(cleanValue);
    }

    function idNumberChange(value) {
      if (value === "") {
        return "";
      }

      const cleanValue = value.replace(/-/g, "");

      if (!/^\d{13}$/.test(cleanValue)) {
        return value;
      }

      return cleanValue.substring(0, 6) + "-" + cleanValue.substring(6);
    }

    function idNumberDoubleCheck(value) {
      if (value === "") {
        return true;
      }

      const regex = /^\d{6}-\d{7}$/;
      return regex.test(value);
    }

    function emailFormatCheck(email) {
      if (email === "") {
        return true;
      }

      const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return regex.test(email);
    }

    function phoneNumberCheck(value) {
      if (value === "") {
        return true;
      }

      const cleanValue = value.replace(/-/g, "");

      const isNumeric = /^\d+$/.test(cleanValue);

      return isNumeric && cleanValue.length <= 11;
    }

    function phoneNumberChange(value) {
      if (value === "") {
        return "";
      }

      const cleanValue = value.replace(/-/g, "").replace(/[^\d]/g, "");

      if (cleanValue.length === 8) {
        return cleanValue.substring(0, 4) + "-" + cleanValue.substring(4);
      } else if (cleanValue.length === 9) {
        if (cleanValue.startsWith("02")) {
          return (
            cleanValue.substring(0, 2) +
            "-" +
            cleanValue.substring(2, 5) +
            "-" +
            cleanValue.substring(5)
          );
        } else {
          return (
            cleanValue.substring(0, 3) +
            "-" +
            cleanValue.substring(3, 6) +
            "-" +
            cleanValue.substring(6)
          );
        }
      } else if (cleanValue.length === 10) {
        if (cleanValue.startsWith("02")) {
          return (
            cleanValue.substring(0, 2) +
            "-" +
            cleanValue.substring(2, 6) +
            "-" +
            cleanValue.substring(6)
          );
        } else {
          return (
            cleanValue.substring(0, 3) +
            "-" +
            cleanValue.substring(3, 6) +
            "-" +
            cleanValue.substring(6)
          );
        }
      } else if (cleanValue.length === 11) {
        return (
          cleanValue.substring(0, 3) +
          "-" +
          cleanValue.substring(3, 7) +
          "-" +
          cleanValue.substring(7)
        );
      } else {
        return cleanValue;
      }
    }

    function phoneNumberDoubleCheck(value) {
      if (value === "") {
        return true;
      }

      const regex =
        /^(01[0-9]{1}-\d{3,4}-\d{4}|02-\d{3,4}-\d{4}|0[3-9]{1}[0-9]{1}-\d{3}-\d{4}|070-\d{4}-\d{4}|\d{4}-\d{4})$/;
      return regex.test(value);
    }

    function updateEducationStatistics() {
      const educationTable = document.getElementById("educationList");
      const rows = educationTable.querySelectorAll("tr");

      let totalCount = rows.length;
      let pendingCount = 0;

      rows.forEach((row) => {
        const completionDate = row
          .querySelector("td:nth-child(5)")
          .textContent.trim();

        if (!completionDate) {
          pendingCount++;
        }
      });

      const pendingElement = document.querySelector(".pending-education");
      const totalElement = document.querySelector(".total-education");

      if (pendingElement && totalElement) {
        pendingElement.textContent = `미이수교육 ${pendingCount}건`;
        totalElement.textContent = `대상교육 ${totalCount}건`;
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      initSupabase();
      initializeData();

      document.getElementById("editBtn").disabled = true;
      document.getElementById("deleteBtn").disabled = true;
      document.getElementById("submitBtn").disabled = false;

      const customModal = document.getElementById("customModal");
      const modalClose = document.querySelector(".modal-close");
      const modalConfirmBtn = document.getElementById("modalConfirmBtn");

      if (modalClose) {
        modalClose.addEventListener("click", function () {
          closeModal();
        });
      }

      if (modalConfirmBtn) {
        modalConfirmBtn.addEventListener("click", function () {
          closeModal();
        });
      }

      const activeMemberBtn = document.getElementById("activeMemberBtn");
      if (activeMemberBtn) {
        activeMemberBtn.addEventListener("click", function () {
          table_CurrentMember();

          allClearContents();

          document.getElementById("submitBtn").disabled = false;
          document.getElementById("resetBtn").disabled = false;
          document.getElementById("editBtn").disabled = true;
          document.getElementById("deleteBtn").disabled = true;
        });
      }

      const allMemberBtn = document.getElementById("allMemberBtn");
      if (allMemberBtn) {
        allMemberBtn.addEventListener("click", function () {
          table_allMember();

          allClearContents();

          document.getElementById("submitBtn").disabled = false;
          document.getElementById("resetBtn").disabled = false;
          document.getElementById("editBtn").disabled = true;
          document.getElementById("deleteBtn").disabled = true;
        });
      }

      document
        .getElementById("deleteBtn")
        .addEventListener("click", async function () {
          const generatedId = document.getElementById("generatedId").value;
          if (!generatedId) {
            showAlert("선택된 회원이 없습니다.");
            return;
          }

          const confirmed = await showConfirmModal(
            "선택한 회원 정보를 정말 삭제하시겠습니까?\n삭제된 데이터는 관리자만 복구할 수 있습니다."
          );

          if (!confirmed) {
            return;
          }

          try {
            showLoading();

            const result = await move_MemberLine(generatedId);

            if (result.success) {
              showAlert("회원 정보가 삭제되었습니다.");

              await loadAllData();

              table_CurrentMember();

              allClearContents();

              document.getElementById("editBtn").disabled = true;
              document.getElementById("deleteBtn").disabled = true;
              document.getElementById("submitBtn").disabled = false;
            } else {
              showAlert("삭제 중 오류가 발생했습니다: " + result.message);
            }
          } catch (error) {
            showAlert("삭제 처리 중 오류가 발생했습니다.");
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("resetBtn")
        .addEventListener("click", function () {
          allClearContents();

          const tableBody = document.getElementById("memberTableBody");
          if (tableBody) {
            const allRows = tableBody.querySelectorAll("tr");
            allRows.forEach((row) => {
              row.classList.remove("selected-row");
            });
          }

          document.getElementById("editBtn").disabled = true;
          document.getElementById("deleteBtn").disabled = true;
          document.getElementById("submitBtn").disabled = false;
        });

      function append_MemberLineData() {
        return new Promise((resolve, reject) => {
          const now = new Date();
          const year = now.getFullYear().toString();
          const month = (now.getMonth() + 1).toString().padStart(2, "0");
          const day = now.getDate().toString().padStart(2, "0");
          const hours = now.getHours().toString().padStart(2, "0");
          const minutes = now.getMinutes().toString().padStart(2, "0");
          const seconds = now.getSeconds().toString().padStart(2, "0");

          const newMemberId =
            "M" + year + month + day + hours + minutes + seconds;
          const formData = {
            generatedId: newMemberId,
            memberId: document.getElementById("memberId").value,
            name: document.getElementById("name").value,
            careNumber: document.getElementById("careNumber").value,
            ssn: document.getElementById("ssn").value,
            birthdate: document.getElementById("birthdate").value,
            age: document.getElementById("age").value,
            admissionDate: document.getElementById("admissionDate").value,
            dischargeDate: document.getElementById("dischargeDate").value,
            address: document.getElementById("address").value,
            mobile: document.getElementById("mobile").value,
            emergencyContact:
              document.getElementById("emergencyContact").value,
            email: document.getElementById("email").value,
            medications: document.getElementById("medications").value,
            allergies: document.getElementById("allergies").value,
            hospital: document.getElementById("hospital").value,
            medicalHistory: document.getElementById("medicalHistory").value,
            guardianRelation:
              document.getElementById("guardianRelation").value,
            guardianName: document.getElementById("guardianName").value,
            guardianContact: document.getElementById("guardianContact").value,
            livingWith: document.getElementById("livingWith").value,
            livingWithName: document.getElementById("livingWithName").value,
            livingWithContact:
              document.getElementById("livingWithContact").value,
            memberNeeds: document.getElementById("memberNeeds").value,
            guardianNeeds: document.getElementById("guardianNeeds").value,
            dailyRoutine: document.getElementById("dailyRoutine").value,
          };

          if (!formData.name) {
            showAlert("회원 이름을 입력해주세요.");
            reject("회원 이름이 입력되지 않았습니다.");
            return;
          }

          processFormData(formData)
            .then(function (result) {
              if (result.success) {
                resolve(result);
              } else {
                showAlert(result.message);
                reject(result.message);
              }
            })
            .catch(function (error) {
              showAlert("오류가 발생했습니다: " + error);
              reject(error);
            });
        });
      }

      function temp_MemberLineData() {
        return new Promise((resolve, reject) => {
          const now = new Date();
          const year = now.getFullYear().toString();
          const month = (now.getMonth() + 1).toString().padStart(2, "0");
          const day = now.getDate().toString().padStart(2, "0");
          const hours = now.getHours().toString().padStart(2, "0");
          const minutes = now.getMinutes().toString().padStart(2, "0");
          const seconds = now.getSeconds().toString().padStart(2, "0");

          const newMemberId =
            "T" + year + month + day + hours + minutes + seconds;
          const formData = {
            generatedId: newMemberId,
            memberId: "상담회원",
            name: document.getElementById("name").value,
            careNumber: document.getElementById("careNumber").value,
            ssn: document.getElementById("ssn").value,
            birthdate: document.getElementById("birthdate").value,
            age: document.getElementById("age").value,
            admissionDate: "",
            dischargeDate: document.getElementById("dischargeDate").value,
            address: document.getElementById("address").value,
            mobile: document.getElementById("mobile").value,
            emergencyContact:
              document.getElementById("emergencyContact").value,
            email: document.getElementById("email").value,
            medications: document.getElementById("medications").value,
            allergies: document.getElementById("allergies").value,
            hospital: document.getElementById("hospital").value,
            medicalHistory: document.getElementById("medicalHistory").value,
            guardianRelation:
              document.getElementById("guardianRelation").value,
            guardianName: document.getElementById("guardianName").value,
            guardianContact: document.getElementById("guardianContact").value,
            livingWith: document.getElementById("livingWith").value,
            livingWithName: document.getElementById("livingWithName").value,
            livingWithContact:
              document.getElementById("livingWithContact").value,
            memberNeeds: document.getElementById("memberNeeds").value,
            guardianNeeds: document.getElementById("guardianNeeds").value,
            dailyRoutine: document.getElementById("dailyRoutine").value,
          };

          if (!formData.name) {
            showAlert("회원 이름을 입력해주세요.");
            reject("회원 이름이 입력되지 않았습니다.");
            return;
          }

          processFormData(formData)
            .then(function (result) {
              if (result.success) {
                resolve(result);
              } else {
                showAlert(result.message);
                reject(result.message);
              }
            })
            .catch(function (error) {
              showAlert("오류가 발생했습니다: " + error);
              reject(error);
            });
        });
      }

      const today = new Date().toISOString().split("T")[0];
      document.getElementById("referenceDate").value = today;

      const ssnField = document.getElementById("ssn");

      ssnField.addEventListener("blur", function () {
        const value = this.value.trim();

        if (value === "") {
          return;
        }

        if (!idNumberCheck(value)) {
          showAlert("주민등록번호는 13자리 숫자여야 합니다.");
          this.value = "";
          this.focus();
          return;
        }

        this.value = idNumberChange(value);

        if (!idNumberDoubleCheck(this.value)) {
          showAlert(
            "주민등록번호 형식이 올바르지 않습니다. (000000-0000000)"
          );
          this.value = "";
          this.focus();
          return;
        }

        const currentMemberId = document.getElementById("memberId").value;
        if (currentMemberId !== "상담회원") {
          const isDuplicate = storedData_all.some(
            (row) => row[4] === this.value
          );
          if (isDuplicate) {
            showAlert("등록된 동일한 주민번호가 있습니다.");
            this.value = "";
            this.focus();
          }
        }
      });

      const dateFields = ["birthdate", "admissionDate", "dischargeDate"];

      dateFields.forEach((fieldId) => {
        const field = document.getElementById(fieldId);

        field.addEventListener("blur", function () {
          const value = this.value.trim();

          if (value !== "" && !date8numberCheck(value)) {
            showAlert("8자리 숫자만 입력 가능합니다. 예) 20230101");
            this.value = "";
            this.focus();
          }

          if (fieldId === "birthdate" && value !== "") {
            const age = manAge(value);
            document.getElementById("age").value = age;
          }
        });
      });

      const emailField = document.getElementById("email");

      emailField.addEventListener("blur", function () {
        const value = this.value.trim();

        if (value !== "" && !emailFormatCheck(value)) {
          showAlert("올바른 이메일 형식이 아닙니다. 예) example@domain.com");
          this.value = "";
          this.focus();
        }
      });

      const phoneFields = [
        "mobile",
        "guardianContact",
        "livingWithContact",
        "emergencyContact",
      ];

      phoneFields.forEach((fieldId) => {
        const field = document.getElementById(fieldId);

        if (field) {
          field.addEventListener("blur", function () {
            const value = this.value.trim();

            if (value === "") {
              return;
            }

            if (!phoneNumberCheck(value)) {
              showAlert("전화번호는 숫자 및 하이픈(-)만 입력 가능합니다.");
              this.value = "";
              this.focus();
              return;
            }

            this.value = phoneNumberChange(value);

            if (!phoneNumberDoubleCheck(this.value)) {
              showAlert("올바른 전화번호 형식이 아닙니다. 예) 010-1234-5678");
              this.value = "";
              this.focus();
            }
          });
        }
      });

      document
        .getElementById("submitBtn")
        .addEventListener("click", async function (e) {
          e.preventDefault();

          if (!validateForm()) {
            return;
          }

          try {
            showLoading();

            const timestamp = new Date().getTime();
            const randomPart = Math.floor(Math.random() * 1000);
            const generatedId = `M${new Date()
              .toISOString()
              .replace(/[-:TZ.]/g, "")}`;

            const currentMemberId = document.getElementById("memberId").value;

            const formData = {
              memberId: currentMemberId,
              name: document.getElementById("name").value,
              careNumber: document.getElementById("careNumber").value,
              ssn: document.getElementById("ssn").value,
              birthdate: document.getElementById("birthdate").value,
              age: document.getElementById("age").value,
              admissionDate: document.getElementById("admissionDate").value,
              dischargeDate: document.getElementById("dischargeDate").value,
              address: document.getElementById("address").value,
              mobile: document.getElementById("mobile").value,
              emergencyContact:
                document.getElementById("emergencyContact").value,
              email: document.getElementById("email").value,
              medications: document.getElementById("medications").value,
              allergies: document.getElementById("allergies").value,
              hospital: document.getElementById("hospital").value,
              medicalHistory: document.getElementById("medicalHistory").value,
              guardianRelation:
                document.getElementById("guardianRelation").value,
              guardianName: document.getElementById("guardianName").value,
              guardianContact:
                document.getElementById("guardianContact").value,
              livingWith: document.getElementById("livingWith").value,
              livingWithName: document.getElementById("livingWithName").value,
              livingWithContact:
                document.getElementById("livingWithContact").value,
              memberNeeds: document.getElementById("memberNeeds").value,
              guardianNeeds: document.getElementById("guardianNeeds").value,
              dailyRoutine: document.getElementById("dailyRoutine").value,
            };

            let serverResponse = null;

            if (currentMemberId === "상담회원") {
              formData.admissionDate = "";

              serverResponse = await new Promise((resolve, reject) => {
                processFormData(formData)
                  .then(function (result) {
                    if (result.success) {
                      showAlert("상담회원 정보가 저장되었습니다.");
                    } else {
                      showAlert(
                        "오류가 발생했습니다: " + (result.message || "")
                      );
                    }
                    resolve(result);
                  })
                  .catch(function (error) {
                    showAlert("오류가 발생했습니다: " + error);
                    reject(error);
                  });
              });
            } else {
              serverResponse = await new Promise((resolve, reject) => {
                processFormData(formData)
                  .then(function (result) {
                    if (result.success) {
                      if (
                        result.memberId &&
                        (currentMemberId === "신규회원등록중" ||
                          currentMemberId === "신규회원전환중")
                      ) {
                        showAlert(
                          `새 회원번호 ${result.memberId}로 등록되었습니다.`
                        );
                      } else {
                        showAlert("회원 정보가 저장되었습니다.");
                      }
                      resolve(result);
                    } else {
                      showAlert(
                        "오류가 발생했습니다: " + (result.message || "")
                      );
                      reject(result.message || "알 수 없는 오류");
                    }
                  })
                  .catch(function (error) {
                    showAlert("오류가 발생했습니다: " + error);
                    reject(error);
                  });
              });
            }

            if (serverResponse && serverResponse.success) {
              await loadAllData();

              table_CurrentMember();

              allClearContents();
            }

            hideLoading();
          } catch (error) {
            hideLoading();
            showAlert("데이터 처리 중 오류가 발생했습니다: " + error);
          }
        });

      document
        .getElementById("editBtn")
        .addEventListener("click", async function (e) {
          e.preventDefault();

          const currentMemberId = document.getElementById("memberId").value;

          let isFormValid = false;
          if (currentMemberId === "상담회원") {
            const name = document.getElementById("name").value;
            const mobile = document.getElementById("mobile").value;
            const ssn = document.getElementById("ssn").value;

            if (!name || !mobile || !ssn) {
              const missingFields = [];
              if (!name) missingFields.push("이름");
              if (!mobile) missingFields.push("연락처");
              if (!ssn) missingFields.push("주민등록번호");
              showAlert(
                `다음 항목을 입력해주세요: ${missingFields.join(", ")}`
              );
              return;
            }
            isFormValid = true;
          } else {
            const validationResult = EntryCheck();

            if (!validationResult.isValid) {
              const missingFieldsText =
                validationResult.missingFields.join(", ");
              showAlert(`다음 항목을 입력해주세요: ${missingFieldsText}`);
              return;
            }
            isFormValid = true;
          }

          if (!isFormValid) {
            return;
          }

          let generatedId = document.getElementById("generatedId").value;
          if (!generatedId || generatedId.trim() === "") {
            if (typeof selectedMemberId !== "undefined" && selectedMemberId) {
              generatedId = selectedMemberId;
            } else {
              showAlert(
                "선택된 회원이 없습니다. 회원을 선택한 후 다시 시도해주세요."
              );
              return;
            }
          }

          try {
            showLoading();

            const moveResult = await new Promise((resolve, reject) => {
              move_MemberLine(generatedId)
                .then(function (result) {
                  if (result.success) {
                    resolve(result);
                  } else {
                    showAlert(
                      "기존 데이터 이동 중 오류가 발생했습니다: " +
                      (result.message || "")
                    );
                    reject(result.message);
                  }
                })
                .catch(function (error) {
                  showAlert(
                    "기존 데이터 이동 중 오류가 발생했습니다: " + error
                  );
                  reject(error);
                });
            });

            const timestamp = new Date().getTime();
            const randomPart = Math.floor(Math.random() * 1000);
            const newGeneratedId = `M${new Date()
              .toISOString()
              .replace(/[-:TZ.]/g, "")}`;

            const formData = {
              generatedId: newGeneratedId,
              memberId: document.getElementById("memberId").value,
              name: document.getElementById("name").value,
              careNumber: document.getElementById("careNumber").value,
              ssn: document.getElementById("ssn").value,
              birthdate: document.getElementById("birthdate").value,
              age: document.getElementById("age").value,
              admissionDate: document.getElementById("admissionDate").value,
              dischargeDate: document.getElementById("dischargeDate").value,
              address: document.getElementById("address").value,
              mobile: document.getElementById("mobile").value,
              emergencyContact:
                document.getElementById("emergencyContact").value,
              email: document.getElementById("email").value,
              medications: document.getElementById("medications").value,
              allergies: document.getElementById("allergies").value,
              hospital: document.getElementById("hospital").value,
              medicalHistory: document.getElementById("medicalHistory").value,
              guardianRelation:
                document.getElementById("guardianRelation").value,
              guardianName: document.getElementById("guardianName").value,
              guardianContact:
                document.getElementById("guardianContact").value,
              livingWith: document.getElementById("livingWith").value,
              livingWithName: document.getElementById("livingWithName").value,
              livingWithContact:
                document.getElementById("livingWithContact").value,
              memberNeeds: document.getElementById("memberNeeds").value,
              guardianNeeds: document.getElementById("guardianNeeds").value,
              dailyRoutine: document.getElementById("dailyRoutine").value,
            };

            let serverResponse = null;
            if (currentMemberId === "상담회원") {
              formData.admissionDate = "";

              serverResponse = await new Promise((resolve, reject) => {
                processFormData(formData)
                  .then(function (result) {
                    if (result.success) {
                      showAlert("상담회원 정보가 수정되었습니다.");
                      resolve(result);
                    } else {
                      showAlert(
                        "오류가 발생했습니다: " + (result.message || "")
                      );
                      reject(result.message || "알 수 없는 오류");
                    }
                  })
                  .catch(function (error) {
                    showAlert("오류가 발생했습니다: " + error);
                    reject(error);
                  });
              });
            } else {
              serverResponse = await new Promise((resolve, reject) => {
                processFormData(formData)
                  .then(function (result) {
                    if (result.success) {
                      if (
                        result.memberId &&
                        currentMemberId === "신규회원전환중"
                      ) {
                        showAlert(
                          `회원이 ${result.memberId} 번호로 전환되었습니다.`
                        );
                      } else {
                        showAlert("회원 정보가 성공적으로 수정되었습니다.");
                      }
                      resolve(result);
                    } else {
                      showAlert(
                        "오류가 발생했습니다: " + (result.message || "")
                      );
                      reject(result.message || "알 수 없는 오류");
                    }
                  })
                  .catch(function (error) {
                    showAlert("오류가 발생했습니다: " + error);
                    reject(error);
                  });
              });
            }

            if (serverResponse && serverResponse.success) {
              await loadAllData();

              table_CurrentMember();

              allClearContents();
            }

            document.getElementById("editBtn").disabled = true;
            document.getElementById("deleteBtn").disabled = true;
            document.getElementById("submitBtn").disabled = false;

            hideLoading();
          } catch (error) {
            hideLoading();
            showAlert("데이터 처리 중 오류가 발생했습니다: " + error);
          }
        });

      const newMemberBtn = document.getElementById("newMemberBtn");
      if (newMemberBtn) {
        newMemberBtn.addEventListener("click", function () {
          allClearContents();

          document.getElementById("memberId").value = "신규회원등록중";

          document.getElementById("submitBtn").disabled = false;
          document.getElementById("editBtn").disabled = true;
          document.getElementById("deleteBtn").disabled = true;

          const tableBody = document.getElementById("memberTableBody");
          if (tableBody) {
            const allRows = tableBody.querySelectorAll("tr");
            allRows.forEach((row) => {
              row.classList.remove("selected-row");
            });
          }
        });
      }

      const counselingMemberBtn = document.getElementById(
        "counselingMemberBtn"
      );
      if (counselingMemberBtn) {
        counselingMemberBtn.addEventListener("click", function () {
          allClearContents();

          const newMemberId = "상담회원";
          document.getElementById("memberId").value = newMemberId;

          document.getElementById("submitBtn").disabled = false;
          document.getElementById("editBtn").disabled = true;
          document.getElementById("deleteBtn").disabled = true;

          const tableBody = document.getElementById("memberTableBody");
          if (tableBody) {
            const allRows = tableBody.querySelectorAll("tr");
            allRows.forEach((row) => {
              row.classList.remove("selected-row");
            });
          }
        });
      }

      const convertBtn = document.getElementById("convertBtn");
      if (convertBtn) {
        convertBtn.addEventListener("click", function () {
          const currentMemberId = document.getElementById("memberId").value;
          if (currentMemberId !== "상담회원") {
            showAlert("상담회원만 회원으로 전환할 수 있습니다.");
            return;
          }

          document.getElementById("memberId").value = "신규회원전환중";

          document.getElementById("submitBtn").disabled = true;
          document.getElementById("editBtn").disabled = false;
          document.getElementById("deleteBtn").disabled = false;

          const tableBody = document.getElementById("memberTableBody");
          if (tableBody) {
            const allRows = tableBody.querySelectorAll("tr");
            allRows.forEach((row) => {
              row.classList.remove("selected-row");
            });
          }

          showAlert("수정 버튼을 눌러 회원으로 전환할 수 있습니다.");
        });
      }

      const memberTable = document.getElementById("memberTable");
      const thead = memberTable.querySelector("thead");
      const tbody = memberTable.querySelector("tbody");
      let currentSort = {
        column: -1,
        direction: "asc",
      };

      thead.addEventListener("click", function (e) {
        if (e.target.tagName === "TH") {
          const column = Array.from(e.target.parentElement.children).indexOf(
            e.target
          );

          if (currentSort.column === column) {
            currentSort.direction =
              currentSort.direction === "asc" ? "desc" : "asc";
          } else {
            currentSort.column = column;
            currentSort.direction = "asc";
          }

          const headers = thead.querySelectorAll("th");
          headers.forEach((header, index) => {
            header.classList.remove("sort-asc", "sort-desc");
            if (index === column) {
              header.classList.add(
                currentSort.direction === "asc" ? "sort-asc" : "sort-desc"
              );
            }
          });

          const rows = Array.from(tbody.querySelectorAll("tr"));
          rows.sort((a, b) => {
            const aValue = a.children[column].textContent.trim();
            const bValue = b.children[column].textContent.trim();

            if (column === 0) {
              if (aValue === "상담회원" && bValue !== "상담회원") {
                return currentSort.direction === "asc" ? -1 : 1;
              }
              if (aValue !== "상담회원" && bValue === "상담회원") {
                return currentSort.direction === "asc" ? 1 : -1;
              }

              if (aValue === bValue) return 0;

              if (aValue.startsWith("M") && bValue.startsWith("M")) {
                const aNum = parseInt(aValue.substring(1), 10);
                const bNum = parseInt(bValue.substring(1), 10);
                return currentSort.direction === "asc"
                  ? aNum - bNum
                  : bNum - aNum;
              }

              return currentSort.direction === "asc"
                ? aValue.localeCompare(bValue)
                : bValue.localeCompare(aValue);
            }

            if ([3, 4, 5].includes(column)) {
              return currentSort.direction === "asc"
                ? Number(aValue) - Number(bValue)
                : Number(bValue) - Number(aValue);
            }

            return currentSort.direction === "asc"
              ? aValue.localeCompare(bValue)
              : bValue.localeCompare(aValue);
          });

          rows.forEach((row) => tbody.appendChild(row));
        }
      });
    });

    function EntryCheck() {
      const requiredFields = [
        { id: "memberId", name: "회원번호" },
        { id: "name", name: "회원명" },
        { id: "careNumber", name: "장기요양번호" },
        { id: "ssn", name: "주민등록번호" },
        { id: "birthdate", name: "생년월일" },
        { id: "admissionDate", name: "입소일" },
        { id: "dischargeDate", name: "퇴소일" },
        { id: "address", name: "주소" },
        { id: "mobile", name: "휴대전화번호" },
        { id: "guardianName", name: "보호자명" },
        { id: "guardianContact", name: "보호자 연락처" },
      ];

      const requiredSelects = [
        { id: "guardianRelation", name: "보호자관계" },
      ];

      const missingFields = [];

      requiredFields.forEach((field) => {
        const element = document.getElementById(field.id);
        if (element && element.value.trim() === "") {
          missingFields.push(field.name);
        }
      });

      requiredSelects.forEach((field) => {
        const element = document.getElementById(field.id);
        if (element && (element.value === "" || element.value === "선택")) {
          missingFields.push(field.name);
        }
      });

      if (missingFields.length > 0) {
        return {
          isValid: false,
          missingFields: missingFields,
        };
      }

      return {
        isValid: true,
        missingFields: [],
      };
    }

    let storedData_all = [];

    function loadAllData() {
      return new Promise(async (resolve, reject) => {
        showLoading();

        try {
          const result = await getData_All();

          if (result.success) {
            if (!result.data || result.data.length === 0) {
              storedData_all = [];
            } else {
              storedData_all = result.data.map((row) => [
                row.회원등록_ID || row.generatedId,
                row.회원번호 || row.memberId,
                row.회원명 || row.name,
                row.장기요양번호 || row.careNumber,
                row.주민등록번호 || row.ssn,
                row.생년월일 || row.birthdate,
                row["(만)나이"] || row.age,
                row.입소일 || row.admissionDate,
                row.퇴소일 || row.dischargeDate,
                row.주소 || "",
                row.휴대전화번호 || row.mobile,
                row.비상연락망 || row.emergencyContact,
                row.이메일주소 || row.email,
                row.복용약물정보 || row.medications,
                row.알레르기정보 || row.allergies,
                row.진료병원 || row.hospital,
                row.주요진료이력 || row.medicalHistory,
                row.보호자관계 || row.guardianRelation,
                row.보호자명 || row.guardianName,
                row.보호자연락처 || row.guardianContact,
                row.동거인관계 || row.livingWith,
                row.동거인명 || row.livingWithName,
                row.동거인연락처 || row.livingWithContact,
                row["회원 주요 기대 및 요구"] || row.memberNeeds,
                row["보호자 주요 기대 및 요구"] || row.guardianNeeds,
                row["주요 하루일과"] || row.dailyRoutine,
              ]);
            }

            hideLoading();
            resolve(storedData_all);
          } else {
            throw new Error(result.message || "데이터 조회 실패");
          }
        } catch (error) {
          hideLoading();
          reject(error);
        }
      });
    }

    async function initializeData() {
      try {
        showLoading();
        await loadAllData();
        table_CurrentMember();
        hideLoading();
      } catch (error) {
        hideLoading();
      }
    }

    function table_allMember() {
      if (!storedData_all || storedData_all.length === 0) {
        showAlert("데이터가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.");
        return;
      }

      const tableBody = document.getElementById("memberTableBody");

      tableBody.innerHTML = "";

      const sortedData = [...storedData_all].sort((a, b) => {
        const memberIdA = a[1] || "";
        const memberIdB = b[1] || "";
        return memberIdA.localeCompare(memberIdB);
      });

      sortedData.forEach((row) => {
        const memberNo = row[1];
        const memberName = row[2];
        const mobile = row[10];
        const birthdate = row[5];
        const admissionDate = row[7];
        const dischargeDate = row[8];
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td>${memberNo}</td>
            <td>${memberName}</td>
            <td>${mobile}</td>
            <td>${birthdate}</td>
            <td>${admissionDate}</td>
            <td>${dischargeDate}</td>
          `;

        tableBody.appendChild(newRow);

        newRow.addEventListener("dblclick", function () {
          const allRows = tableBody.querySelectorAll("tr");
          allRows.forEach((r) => r.classList.remove("selected-row"));
          newRow.classList.add("selected-row");

          document.getElementById("editBtn").disabled = false;
          document.getElementById("deleteBtn").disabled = false;
          document.getElementById("submitBtn").disabled = true;

          fillMemberData(row);
        });
      });
    }

    function fillMemberData(data) {
      selectedMemberId = data[0] || "";

      document.getElementById("generatedId").value = selectedMemberId;

      document.getElementById("memberId").value = data[1] || "";
      document.getElementById("name").value = data[2] || "";
      document.getElementById("careNumber").value = data[3] || "";
      document.getElementById("ssn").value = data[4] || "";
      document.getElementById("birthdate").value = data[5] || "";
      document.getElementById("age").value = data[6] || "";
      document.getElementById("admissionDate").value = data[7] || "";
      document.getElementById("dischargeDate").value = data[8] || "";
      document.getElementById("address").value = data[9] || "";
      document.getElementById("mobile").value = data[10] || "";
      document.getElementById("emergencyContact").value = data[11] || "";
      document.getElementById("email").value = data[12] || "";

      const medications = document.getElementById("medications");
      if (medications) medications.value = data[13] || "";

      const allergies = document.getElementById("allergies");
      if (allergies) allergies.value = data[14] || "";

      const hospital = document.getElementById("hospital");
      if (hospital) hospital.value = data[15] || "";

      const medicalHistory = document.getElementById("medicalHistory");
      if (medicalHistory) medicalHistory.value = data[16] || "";

      const guardianRelation = document.getElementById("guardianRelation");
      if (guardianRelation) guardianRelation.value = data[17] || "";

      const guardianName = document.getElementById("guardianName");
      if (guardianName) guardianName.value = data[18] || "";

      const guardianContact = document.getElementById("guardianContact");
      if (guardianContact) guardianContact.value = data[19] || "";

      const livingWith = document.getElementById("livingWith");
      if (livingWith) livingWith.value = data[20] || "";

      const livingWithName = document.getElementById("livingWithName");
      if (livingWithName) livingWithName.value = data[21] || "";

      const livingWithContact = document.getElementById("livingWithContact");
      if (livingWithContact) livingWithContact.value = data[22] || "";

      const memberNeeds = document.getElementById("memberNeeds");
      if (memberNeeds) memberNeeds.value = data[23] || "";

      const guardianNeeds = document.getElementById("guardianNeeds");
      if (guardianNeeds) guardianNeeds.value = data[24] || "";

      const dailyRoutine = document.getElementById("dailyRoutine");
      if (dailyRoutine) dailyRoutine.value = data[25] || "";
    }

    function table_CurrentMember() {
      if (!storedData_all || storedData_all.length === 0) {
        showAlert("표시할 회원 데이터가 없습니다.");
        return;
      }

      const tableBody = document.getElementById("memberTableBody");
      const referenceDate = document.getElementById("referenceDate").value;

      const formattedRefDate = referenceDate.replace(/-/g, "");

      tableBody.innerHTML = "";

      const currentMembers = storedData_all.filter((row) => {
        if (row[1] === "상담회원") {
          return false;
        }

        const admissionDate = row[7] || "";
        const dischargeDate = row[8] || "99991231";

        const admDateNum = parseInt(admissionDate) || 0;
        const dischargeDateNum = parseInt(dischargeDate) || 99991231;
        const refDateNum = parseInt(formattedRefDate) || 0;

        return refDateNum >= admDateNum && refDateNum <= dischargeDateNum;
      });

      const sortedMembers = [...currentMembers].sort((a, b) => {
        const memberIdA = a[1] || "";
        const memberIdB = b[1] || "";
        return memberIdA.localeCompare(memberIdB);
      });

      sortedMembers.forEach((row) => {
        const memberNo = row[1];
        const memberName = row[2];
        const mobile = row[10];
        const birthdate = row[5];
        const admissionDate = row[7];
        const dischargeDate = row[8];

        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td>${memberNo}</td>
            <td>${memberName}</td>
            <td>${mobile}</td>
            <td>${birthdate}</td>
            <td>${admissionDate}</td>
            <td>${dischargeDate}</td>
          `;

        tableBody.appendChild(newRow);

        newRow.addEventListener("dblclick", function () {
          const allRows = tableBody.querySelectorAll("tr");
          allRows.forEach((r) => r.classList.remove("selected-row"));
          newRow.classList.add("selected-row");

          document.getElementById("editBtn").disabled = false;
          document.getElementById("deleteBtn").disabled = false;
          document.getElementById("submitBtn").disabled = true;

          fillMemberData(row);
        });
      });
    }

    function move_MemberLineData() {
      return new Promise((resolve, reject) => {
        const memberId = selectedMemberId;

        if (!memberId) {
          showAlert("회원등록_ID가 없습니다. 회원을 먼저 선택해주세요.");
          reject("회원등록_ID가 없습니다.");
          return;
        }

        move_MemberLine(memberId)
          .then(function (result) {
            if (result.success) {
              resolve(result);
            } else {
              showAlert(result.message);
              reject(result.message);
            }
          })
          .catch(function (error) {
            showAlert("회원 데이터 이동 중 오류가 발생했습니다: " + error);
            reject(error);
          });
      });
    }

    function validateForm() {
      const currentMemberId = document.getElementById("memberId").value;

      if (currentMemberId === "상담회원") {
        const name = document.getElementById("name").value;
        const mobile = document.getElementById("mobile").value;
        const ssn = document.getElementById("ssn").value;

        if (!name || !mobile || !ssn) {
          const missingFields = [];
          if (!name) missingFields.push("이름");
          if (!mobile) missingFields.push("연락처");
          if (!ssn) missingFields.push("주민등록번호");
          showAlert(`다음 항목을 입력해주세요: ${missingFields.join(", ")}`);
          return false;
        }
        return true;
      } else {
        const validationResult = EntryCheck();
        if (!validationResult.isValid) {
          const missingFieldsText = validationResult.missingFields.join(", ");
          showAlert(`다음 항목을 입력해주세요: ${missingFieldsText}`);
          return false;
        }
        return true;
      }
    }
  </script>
</body>

</html>